### 索引

####   索引是什么

​     索引是一种数据结构，帮助MySQL高效获取数据。在MySQL中使用B+树作为索引的数据结构，在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构以某种方式引用（指向）数据。如果不使用索引，数据库在查找数据的时候会进行全表的逐行扫描，一般来说索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储的磁盘上。（索引也可以指定使用hash作为存储，但是这种存储虽然检索块，但是范围检索慢）

####   索引的劣势

-  虽然索引大大提高了查询速度，同时却会降低更新表的速度，如对表进行INSERT、UPDATE和DELETE。
    因为更新表时，MySQL不仅要保存数据，还要保存一下索引文件每次更新添加了索引列的字段，
    都会调整因为更新所带来的键值变化后的索引信息 
- 实际上索引也是一张表，该表保存了主键与索引字段，并指向实体表的记录，所以索引列也是要占用空间的



####   索引的分类

-   **聚集索引**：亦可称为主键索引。一张表只存在一个聚集索引。聚集索引是根据其主键作为排序规则的B+树，搜索时根据其主键进行搜索，其中叶子节点上存储着整条记录的数据，**InnoDB 主键使用的是聚集索引**（这就是为什么InnoDB要求我们要创建主键，如果没有创建主键会自动创建一个自增序列.而且还推荐最好使用数值型数据？为了更容易比较大小）

-   **非聚集索引**：非聚集索引又称辅助索引，以非主键列来建立。非聚集索引可以有多个。非聚集索引和聚集索引的区别在于，**非聚集索引的叶子节点并不存储整条记录的数据，而是存储指向的主键的指针。所以，当利用非主键索引进行搜索时，还需要通过主键索引获取整条数据**（回表）（InnoDB的非主键索引使用的是非聚集索引，而MyISAM使用的是非聚集索引）
    - **单值索引**：一个索引只包含单个列，一个表可以有多个单列索引。与主键索引类似，单值索引按照所指定列排序建立二叉树。当利用单值搜索到目标后，再通过主键索引去读取整条数据。
    - **唯一索引：**唯一索引与单值索引区别不大，只是唯一索引的值不会重复
    - **联合索引：**创建联合索引时指定多列即可，联合索引会按照建立索引时的顺序，对每个字段进行排序。即第一个字段排完序，接着排第二个字段，第三...
    - **覆盖索引：**非聚集索引搜索记录时还需要通过的主键索引，但如果查找的列刚刚好是联合索引的字段，那就没有必要去再去搜索主键索引，直接取叶子节点值即可，这就是覆盖索引。为什么不用`select *`，原因就在此，不仅仅是为了减少读取更多列带来的开销，也是为了能够使用上覆盖索引。使用覆盖索引可以减少磁盘IO，有效提高性能





**为什么InnoDB的非聚集索引保存的是主键的值而不是整条记录？**

​        因为聚集索引的叶子节点保存  的是整条记录，如果非聚集索引也保存的是整条记录会有数据的冗余，占用更多的空间，而且聚集索引保存一份记录，非聚集索引也要保存一份记录，那么在数据表的数据更新的时候要维护两份记录，这样可能会涉及分布式事务的一致性 

**为什么InnoDB一定要有主键？**

  InnoDB中数据表，可以利用到聚集索引，如果我们没有创建主键，那么mysql会在后台为我们生成主键

 而且主键最好使用自增类型的 （为了查找数据的时候id的比较更快）

  



#### 聚集索引的优点

        1. 当你需要取出一定范围内的数据时，用聚簇索引也比用非聚簇索引好
        2. 当通过聚簇索引查找目标数据时理论上比非聚簇索引要快，因为非聚簇索引定位到对应主键时还要多一次目标记录寻址,即多一次I/O

![](https://keyon-edu.oss-cn-beijing.aliyuncs.com/data/index.png)

#### 聚集索引的缺点

     1. 为了充分利用聚簇索引的聚簇的特性，所以innodb表的主键列尽量选用有序的顺序id，而不建议用无序的id，比如uuid这种
    
     2. 采用聚簇索引插入新值比采用非聚簇索引插入新值的速度要慢很多。因为插入要保证主键不能重复，判断主键不能重复，采用的方式在不同的索引下面会有很大的性能差距，聚簇索引遍历所有的叶子节点，非聚簇索引也判断所有的叶子节点，但是聚簇索引的叶子节点除了带有主键还有记录值，记录的大小往往比主键要大的多。这样就会导致聚簇索引在判定新记录携带的主键是否重复时进行昂贵的I/O代价



####        操作索引的指令

​       **创建索引**： create index 索引名 on 表名（字段1，字段2.......)     

​       **删除索引**：drop index 索引名 on 表名



#### 那些情况需要创建索引

                1. 主键自动建立唯一索引
                2. 频繁作为查询条件的字段应该创建索引
                3. 查询中与其它表关联的字段，外键关系建立索引
                4. 查询中排序的字段，排序字段若通过索引去访问将大大提高排序速度
                5. 查询中统计或者分组字段
                6. 单键/组合索引的选择问题， 组合索引性价比更高



#### 那些情况不需要创建索引

1. 表记录太少
2. 经常增删改的表或者字段
3. Where条件里用不到的字段不创建索引
4. 过滤性不好的不适合建索引



**InnoDB有两个数据库文件，.ibd中保存的是文件和索引，.frm中保存的是表格式，而MyISM中有三个文件frm保存的是表的格式，.myi保存的是索引   .myd保存的是数据**



![](https://keyon-edu.oss-cn-beijing.aliyuncs.com/data/%E3%80%81%E8%BE%85%E5%8A%A9%E7%B4%A2%E5%BC%95.png)



![](https://keyon-edu.oss-cn-beijing.aliyuncs.com/data/%E7%B4%A2%E5%BC%95%E5%88%86%E7%B1%BB.png)



